<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/feed_main.css') }}">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <!-- Font Awesome -->
    <script src="https://kit.fontawesome.com/bee3d4f913.js" crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100;300;400;500;700;900&display=swap"
          rel="stylesheet">

    <!-- JS -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.js"></script>


    <script>
        // 로그아웃은 내가 가지고 있는 토큰만 쿠키에서 없애면 됩니다.
        function logout() {
            $.ajax({
                type: "GET",
                url: '/logout',
                data: {},
                success: function (response) {
                    $.removeCookie('mytoken');
                    alert(response['msg'])
                    window.location.href = '/login'
                }
            })

        }

    </script>
    <!-- Title -->
    <title>인스타그램 클론 플젝</title>

</head>
<script type="text/javascript">
    $(document).ready(function () {
        showFeed();
    });

    // Feed 조회 - GET
    function showFeed() {
        $.ajax({
            type: "GET",
            url: "/",
            data: "",
            success: function (response) {
                alert(response["msg"]);
            }
        })
    }
    
    // 댓글 작성 - POST
    function reply_write(nickname, feed_num) {
        let reply_content = $(".feed_reply_write").val()
        // console.log('댓글 닉네임, 내용, Feed 넘버', nickname, reply_conten, feed_num)
        $.ajax({
            type:'POST',
            url: "/api/reply/writing",
            data: { nickname:nickname, reply_content: reply_content, feed_num:feed_num},
            success: function (response) {
                alert(response["msg"]);
                window.location.reload();
            }
        })
    }

    // 좋아요/안좋아요 DB 수정 - POST
    function like_func(nickname, feed_num){
        let heart = $("#heart").text()
        let is_like = 0;
        if (heart == '♥'){
            is_like = 1;
        }else{
            is_like = 0;
        }
        console.log('===', nickname, feed_num, heart, is_like)
        $.ajax({
            type:'POST',
            url: '/api/like',
            data: {nickname:nickname, feed_num:feed_num, is_like:is_like}, // like가 0이면 안좋아함, 1이면 좋아함
            success: function (response){
                alert(response["msg"]);
                window.location.reload();
            }
        })
    }

    // 좋아요/안좋아요 DB 수정 - POST
    function bookmark_func(nickname, feed_num){
        let bookmark = $("#bookmark").text()
        let is_bookmark = 0;
        if (bookmark == '■'){
            is_bookmark = 1;
        }else{
            is_bookmark = 0;
        }
        console.log('======', nickname, feed_num, bookmark, is_bookmark)
        $.ajax({
            type:'POST',
            url: '/api/bookmark',
            data: {nickname:nickname, feed_num:feed_num, is_bookmark:is_bookmark}, // like가 0이면 안좋아함, 1이면 좋아함
            success: function (response){
                alert(response["msg"]);
                window.location.reload();
            }
        })
    }
</script>

<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid" style="justify-content: space-between; flex-wrap: nowrap; min-width: 1000px">
        <!-- Brand Logo -->
        <div>
            <a class="navbar-brand">
                <img style='width:100px;'
                     src="https://www.instagram.com/static/images/web/mobile_nav_type_logo-2x.png/1b47f9d0e595.png">
            </a>
        </div>

        <!-- Search Bar -->
        <div>
            <input class="form-control me-2" style="width: 400px" type="search" placeholder="Search"
                   aria-label="Search">
        </div>

        <!-- nav 상단 바로가기 -->
        <div class="nav-btns">
            <div class="nav-btn"><i class="fa-solid fa-house"></i></div>
            <div class="nav-btn"><i class="fa-regular fa-message"></i></div>
            <div class="nav-btn"><i class="fa-regular fa-pen-to-square"></i></div>
            <div class="nav-btn"><i class="fa-regular fa-compass"></i></div>
            <div class="nav-btn"><i class="fa-regular fa-heart"></i></div>
            <div class="nav-btn"><i class="fa-regular fa-user"></i></div>
        </div>
    </div> <!-- nav안 main div -->
</nav>

<div class="article">
    <div class="feed_box_area">
        <!-- 여기서부터 피드박스 -->
        {% for feed in feeds %}
        <div class="feed_box">
            <!-- 피드 - 첫 헤더 (프로필 이미지, 닉네임 등)-->
            <div class='feed_header_div'>
                <a id = "tag_a" href="{{url_for('profile', feed_nickname = feed.nickname)}}">
                    <div class='feed_profile_div'>
                        <div class="profile_box_div">
                            <img class="profile" src="{{ feed.profile_img}}">
                        </div>
                        <div>{{ feed.nickname }}</div>
                    </div>
                </a>
                <div class="extra_modal"><b>···</b>
                </div>
            </div>

            <!-- 피드 - 프로필 이미지-->
            <div>
                <img class='feed_images' src="{{ feed.feed_images[0] }}">
            </div>

            <!-- 피드 본문 좋아요, 게시글 보기, 공유하기, 북마크-->
            <div>
                <div class='feed_like_bookmark_div'>
                    <!-- 좋아요 -->
                    <div>
                        <span onclick = "like_func('{{user_info.nickname}}', '{{feed.num}}')">
                        {% set nickname_list = [] %}
                        {% for like_dict in feed.like %}
                            <!-- {{ nickname_list.append(like_dict['nickname']) }} -->
                        {% endfor %}
                        {% if user_info.nickname in nickname_list %}
                            <span id='heart'>♥</span>
                        {% else %}
                            <span id='heart'>♡</span>
                        {% endif %}
                        </span>

                        <!-- 게시글 보기, 공유하기-->
                        <span class="favorite material-icons-outlined"><i class="fa-regular fa-message"></i></span>
                        <span class="favorite material-icons-outlined"><i class="fa-regular fa-paper-plane"></i></span>
                    </div>
                    <!-- bookmark -->
                    <div onclick = "bookmark_func('{{user_info.nickname}}', '{{feed.num}}')">
                        {% set nickname_list = [] %}
                        {% for bookmark_dict in feed.bookmark %}
                            <!-- {{ nickname_list.append(bookmark_dict['nickname']) }} -->
                        {% endfor %}
                        {% if user_info.nickname in nickname_list %}
                            <span id='bookmark'>■</span>
                        {% else %}
                            <span id='bookmark'>□</span>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- 피드 본문, 좋아요-->
            <div class="feed_like_div">좋아요 {{ feed.like|length}}개</div>
            <div class="feed_content_div">
                <b>{{ feed.nickname }}</b>&nbsp;{{ feed.content }}
            </div>

            <!-- 피드 본문 Tag -->
            <div class='feed_tag_div'> #tag1 #tag2 #tag3 #tag4</div>

            <!-- 댓글 더보기 -->
            <div class='feed_reply_view_div'>
                댓글 {{feed.reply|length}}개 더보기
            </div>

            <!-- 댓글 View -->
            <div>
                {% for reply in feed.reply[::-1][:2] %}
                <div class='feed_reply_div'>
                    <b>{{ reply.nickname }}</b> &nbsp; {{ reply.content }}
                </div>
                {% endfor %}
            </div>

            <!-- 댓글 달기 -->
            <div class="feed_reply_write_div">
                <input type="text" class="feed_reply_write" placeholder="댓글 달기..">
                <button class="feed_reply_upload" onclick="reply_write('{{user_info.nickname}}', '{{feed.num}}')">게시</button>
            </div>
        </div>
        {% endfor %}
    </div> <!-- feed_box_area -->
    <div class="modal hidden">
        <div class="bg"></div>
        <div class="modalBox">
          <p>인스타 게시글 모달 입니다.</p>
          <button class="closeBtn">✖</button>
        </div>
    </div>
    <!-- 여기까지 피드박스 -->

    <!-- 추천 박스 -->
    <div class="recommend_box">
        <!-- 마이 프로필 -->
        <div style="display: flex;flex-direction: row; align-items: center; margin: 20px">
            프로필구역

        </div>
        <!-- 회원님을 위한 추천 -->
        <div style="display: flex;flex-direction: row; justify-content: space-between; margin:15px 0px 15px 0px">
            <div style="font-weight: bold; color: gray">
                회원님을 위한 추천
            </div>
            <div>
                <a href="#" style="font-weight: bold;color: black;text-decoration: none">모두보기</a>
            </div>
        </div>
        <div style="display:flex; flex-direction:row; justify-content: space-between; align-items: center; margin:10px 0px 10px 0px">
            <div style="display: flex; flex-direction: row">
                <div class="box" style="width: 35px; height: 35px">
                    <img class="profile"
                         src="http://file3.instiz.net/data/file3/2021/05/31/e/b/8/eb8d9ad2d779ca2a0b7acc2b67694a23.png">
                </div>
                <div style="margin-left:10px; text-align:left">
                    <div style="font-weight:bold; font-size: 14px">
                        김xx
                    </div>
                    <div style="color:gray; font-size:14px">
                        친구1
                    </div>
                </div>
            </div>

            <div>
                <a href="#" style="font-size:14px; font-weight:bold; text-decoration:none">팔로우</a>
            </div>
        </div>
        <div style="display:flex; flex-direction:row; justify-content: space-between; align-items: center; margin:10px 0px 10px 0px">
            <div style="display: flex; flex-direction: row">
                <div class="box" style="width: 35px; height: 35px">
                    <img class="profile"
                         src="http://file3.instiz.net/data/file3/2021/05/31/e/b/8/eb8d9ad2d779ca2a0b7acc2b67694a23.png">
                </div>
                <div style="margin-left:10px; text-align:left">
                    <div style="font-weight:bold; font-size: 14px">
                        박xx
                    </div>
                    <div style="color:gray; font-size:14px">
                        친구2
                    </div>
                </div>
            </div>

            <div>
                <a href="#" style="font-size:14px; font-weight:bold; text-decoration:none">팔로우</a>
            </div>
        </div>
        <div style="display:flex; flex-direction:row; justify-content: space-between; align-items: center; margin:10px 0px 10px 0px">
            <div style="display: flex; flex-direction: row">
                <div class="box" style="width: 35px; height: 35px">
                    <img class="profile"
                         src="http://file3.instiz.net/data/file3/2021/05/31/e/b/8/eb8d9ad2d779ca2a0b7acc2b67694a23.png">
                </div>
                <div style="margin-left:10px; text-align:left">
                    <div style="font-weight:bold; font-size: 14px">
                        이xx
                    </div>
                    <div style="color:gray; font-size:14px">
                        친구3
                    </div>
                </div>
            </div>

            <div>
                <a href="#" style="font-size:14px; font-weight:bold; text-decoration:none">팔로우</a>
            </div>
        </div>
        <div style="margin-top: 50px;font-size: 12px;color: gray; text-align: left"> 소개·도움말·홍보 센터·API·채용 정보 <br>
            개인정보처리방침·약관·위치·인기 계정·해시태그·언어
        </div>
        <button type="button" onclick="logout()">로그아웃</button>
        <div style="margin-top: 20px;font-size: 12px;color: gray; text-align: left"> © 2022 INSTAGRAM FROM META</div>
    </div>
</div>

<!--
<footer class='footer' style='background-color:black; height:80px; display:flex; justify-content:center; align-item:center;'>
    <div class='footer-text' style='color:white; font-size:20px;'>
        Seonmin Kim Instgram Clone Coding Project
    </div>
</footer>
-->
</body>
<script>
    const open = () => {
        console.log('open')
        document.querySelector(".modal").classList.remove("hidden");
      }
    
      const close = () => {
        console.log('close')
        document.querySelector(".modal").classList.add("hidden");
      }
    
      document.querySelector(".feed_reply_view_div").addEventListener("click", open);
      document.querySelector(".closeBtn").addEventListener("click", close);
      document.querySelector(".bg").addEventListener("click", close);
</script>
</html>