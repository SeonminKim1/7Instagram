<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"></script>

    <!-- CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/feed_main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/navstyle.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/feed_modal.css') }}">

    <!-- Font Awesome -->
    <script src="https://kit.fontawesome.com/bee3d4f913.js" crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100;300;400;500;700;900&display=swap"
          rel="stylesheet">

    <!-- JS -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <!--쿠키를 사용하기 위한 cdn -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.js"></script>
    
    <!-- Title -->
    <title>인스타그램 클론 플젝</title>

</head>
<script type="text/javascript">
    $(document).ready(function () {
        showFeed();
    });

    window.onload = function () {
        function onClick() {
            document.querySelector('.modal-post').style.display = 'block';
            document.querySelector('.modal-overlay').style.display = 'block';
        }

        function offClick() {
            document.querySelector('.modal-post').style.display = 'none';
            document.querySelector('.modal-overlay').style.display = 'none';
        }
        document.getElementById('btn-post').addEventListener('click', onClick);
        document.querySelector('.modal-close').addEventListener('click', offClick);
    };

    // Feed 조회 - GET
    function showFeed() {
        $.ajax({
            type: "GET",
            url: "/",
            data: "",
        })
    };

    // 댓글 작성 - POST
    function reply_write(nickname, feed_num) {
        let feed_reply_content = $(".feed_reply_write_"+ feed_num).val()
        let modal_reply_content = $(".modal_feed_reply_write_"+ feed_num).val()
        let reply_content = undefined
        if(feed_reply_content === ''){
            reply_content = modal_reply_content
        }
        else{
            reply_content = feed_reply_content
        }
        console.log('===', reply_content, '===', modal_reply_content)
        // console.log('댓글 닉네임, 내용, Feed 넘버', nickname, reply_conten, feed_num)
        $.ajax({
            type: 'POST',
            url: "/api/reply/writing",
            data: {nickname: nickname, reply_content: reply_content, feed_num: feed_num},
            success: function (response) {
                alert(response["msg"]);
                window.location.reload();
            }
        })
    };

    // 좋아요/안좋아요 DB 수정 - POST
    function like_func(nickname, feed_num){
        let heart = event.target.attributes.getNamedItem('data-heart').value;
        let is_like = 0;
        if (heart == '1'){
            is_like = 1;
        } else {
            is_like = 0;
        }
        console.log('===', nickname, feed_num, heart, is_like)
        $.ajax({
            type: 'POST',
            url: '/api/like',
            data: {nickname: nickname, feed_num: feed_num, is_like: is_like}, // like가 0이면 안좋아함, 1이면 좋아함
            success: function (response) {
                alert(response["msg"]);
                window.location.reload();
            }
        })
    };

    // 좋아요/안좋아요 DB 수정 - POST
    function bookmark_func(nickname, feed_num){
        let bookmark = event.target.attributes.getNamedItem('data-bookmark').value;
        let is_bookmark = 0;
        if (bookmark == '1'){
            is_bookmark = 1;
        } else {
            is_bookmark = 0;
        }
        console.log('======', nickname, feed_num, bookmark, is_bookmark)
        $.ajax({
            type: 'POST',
            url: '/api/bookmark',
            data: {nickname: nickname, feed_num: feed_num, is_bookmark: is_bookmark}, // like가 0이면 안좋아함, 1이면 좋아함
            success: function (response) {
                alert(response["msg"]);
                window.location.reload();
            }
        })
    };

    // 팔로우/언팔로우
    function follow(reco_nickname) {
        alert(reco_nickname + '팔로우!')
        reco_nick = reco_nickname
        $.ajax({
            type: "POST",
            url: "/api/follow",
            data: {'nick_give': reco_nickname},
            success: function (response) {
                if (response['is_following'] == 1) {
                    alert('팔로우 완료')
                    let temp_html = `<a onclick="follow(reco_nick)" style="font-size:14px; font-weight:bold; text-decoration:none; color: black">팔로잉</a>`
                    $('#follow' + reco_nickname).html(temp_html)
                } else {
                    alert('언팔로우 완료')
                    let temp_html = `<a onclick="follow(reco_nick)" style="font-size:14px; font-weight:bold; text-decoration:none;">팔로우</a>`
                    $('#follow' + reco_nickname).html(temp_html)
                }
            }
        })
    }

    // 로그아웃
    function logout() {
        $.ajax({
            type: "GET",
            url: '/logout',
            data: {},
            success: function (response) {
                $.removeCookie('mytoken');
                alert(response['msg'])
                window.location.href = '/login'
            }
        })

    }

    // feed Modal Func
    function feed_modal_func(feed_num){
        console.log(feed_num, typeof(feed_num))
        document.querySelector('.modal_post_'+ feed_num).style.display = 'flex';
        document.querySelector('.modal_overlay_'+ feed_num).style.display = 'block';
    }
</script>

<body>
    <nav id="nav" class="navbar navbar-expand-lg navbar-light bg-light fixed-top">{% include 'nav/nav.html' %}</nav>
    <!-- nav 모달 -->
    <div class="modal-overlay">
        <div class="modal-post">
            <div class="box-modal">
                <div class="post-title">새 게시물 만들기</div>
                <img alt=img-upload class="post-img" src="static/nav-img/posting.png">
                <div class="post-info">사진과 동영상을 여기에 끌어다 놓으세요</div>
                <button class="btn-content">컴퓨터에서 선택</button>
                <div class="modal-close"><a href="#">close</a></div>
            </div>
        </div>
    </div>

    <!-- 진행중인 Feed 게시글 modal -->
    {% for feed in feeds %}
        <div class="modal_overlay_{{feed.num}}" 
            style="display:none; position:absolute;
                    width:100%; height:500%; 
                    background-color: rgba(0, 0, 0, 0.8);
                    top:0; left:0; z-index:9999;">
            <div class="modal_post_{{feed.num}}" 
                style="display:none; height:1000px; width:1000px; 
                        margin:60px auto auto auto;
                        border: 1px solid black; 
                        border-radius:10px; background-color:#FFFFFF; 
                        flex-direction:row; text-align:center; 
                        justify-content:center;">
                
                <!-- modal post img -->
                <div class="modal_post_img_div">
                    <img class='modal-feed-img' src="{{ feed.feed_images[0] }}">
                </div>

                <!-- modal post content -->
                <!-- 모달 게시글 헤더 --> 
                <div class='modal_post_content_div'>
                    <div class='modal_feed_header_div'>
                        <a id="modal_tag_a" href="{{ url_for('profile', feed_nickname = feed.nickname) }}">
                            <div class='modal_feed_profile_div'>
                                <div class="profile_box_div">
                                    <img class="modal_profile" src="{{ feed.profile_img }}">
                                </div>  
                                <div>{{ feed.nickname }}</div>
                            </div>
                        </a>
                        <div class="modal_extra_modal">
                            <img class="like-icon" src="{{url_for('static', filename='img/more.png') }}">
                        </div>
                    </div>
                    <!-- 모달 게시글 내용 -->
                    <div class="modal_feed_content_div">
                        <b>{{ feed.nickname }}</b>&nbsp;{{ feed.content }}
                    </div>

                    <!-- 피드 본문 좋아요, 게시글 보기, 공유하기, 북마크-->
                    <div>
                        <div class='modal_feed_like_bookmark_div'>
                            <!-- 좋아요 -->
                            <div>
                                <span onclick="like_func('{{ users.nickname }}', '{{ feed.num }}')">
                                    {% set nickname_list = [] %}
                                    {% for like_dict in feed.like %}
                                        <!-- {{ nickname_list.append(like_dict['nickname']) }} -->
                                    {% endfor %}
                                    {% if users.nickname in nickname_list %}
                                        <img class="like-icon" src="{{url_for('static', filename='img/heart-solid.svg') }}" data-heart="1">
                                    {% else %}
                                        <img class="like-icon" src="{{url_for('static', filename='img/heart-regular.svg') }}" data-heart="0">
                                    {% endif %}
                                </span>

                                <!-- 게시글 보기, 공유하기-->
                                <img class="message-icon" src="{{url_for('static', filename='img/message-regular.svg') }}">
                                <img class="paper-plane-icon" src="{{url_for('static', filename='img/paper-plane-regular.svg') }}">
                            </div>
                            <!-- bookmark -->
                            <div onclick = "bookmark_func('{{users.nickname}}', '{{feed.num}}')">
                                {% set nickname_list = [] %} 
                                {% for bookmark_dict in feed.bookmark %}
                                    <!-- {{ nickname_list.append(bookmark_dict['nickname']) }} -->
                                {% endfor %}
                                {% if users.nickname in nickname_list %}
                                    <img class="bookmark-icon" src="{{url_for('static', filename='img/bookmark-solid.svg') }}" data-bookmark="1">
                                {% else %}
                                    <img class="bookmark-icon" src="{{url_for('static', filename='img/bookmark-regular.svg') }}" data-bookmark="0">
                                {% endif %}
                            </div>
                        </div>

                        <!-- 피드 본문, 좋아요-->
                        <div class="modal_feed_like_div">좋아요 {{ feed.like|length }}개</div>
                    </div>

                    <!-- 댓글 View -->
                    <div>
                        {% for reply in feed.reply[::-1] %}
                            <div class='modal_feed_reply_div'>
                                <b>{{ reply.nickname }}</b> &nbsp; {{ reply.content }}
                            </div>
                        {% endfor %}
                    </div>

                    <!-- 댓글 달기 -->
                    <div class="modal_feed_reply_write_div">
                        <input type="text" class="modal_feed_reply_write_{{feed.num}}" placeholder="댓글 달기.."
                            style="box-shadow:none; border: none; outline: none; width:400px;">
                        <button class="modal_feed_reply_upload" onclick="reply_write('{{ users.nickname }}', '{{ feed.num }}')">
                            게시
                        </button>
                    </div>
                </div> <!--post-content-->
            </div>
        </div>
    {% endfor %}

    <div class="article">
        <div class="feed_box_area">
            <!-- 여기서부터 피드박스 -->
            {% for feed in feeds %}
                <div class="feed_box">
                    <!-- 피드 - 첫 헤더 (프로필 이미지, 닉네임 등)-->
                    <div class='feed_header_div'>
                        <a id="tag_a" href="{{ url_for('profile', feed_nickname = feed.nickname) }}">
                            <div class='feed_profile_div'>
                                <div class="profile_box_div">
                                    <img class="profile" src="{{ feed.profile_img }}">
                                </div>
                                <div>{{ feed.nickname }}</div>
                            </div>
                        </a>
                        <div class="extra_modal"><img class="like-icon" src="{{url_for('static', filename='img/more.png') }}">
                        </div>
                    </div>

                    <!-- 피드 - 프로필 이미지-->
                    <div>
                        <img class='feed_images' src="{{ feed.feed_images[0] }}">
                    </div>

                    <!-- 피드 본문 좋아요, 게시글 보기, 공유하기, 북마크-->
                    <div>
                        <div class='feed_like_bookmark_div'>
                            <!-- 좋아요 -->
                            <div>
                                <span onclick="like_func('{{ users.nickname }}', '{{ feed.num }}')">
                                    {% set nickname_list = [] %}
                                    {% for like_dict in feed.like %}
                                        <!-- {{ nickname_list.append(like_dict['nickname']) }} -->
                                    {% endfor %}
                                    {% if users.nickname in nickname_list %}
                                        <img class="like-icon" src="{{url_for('static', filename='img/heart-solid.svg') }}" data-heart="1">
                                    {% else %}
                                        <img class="like-icon" src="{{url_for('static', filename='img/heart-regular.svg') }}" data-heart="0">
                                    {% endif %}
                                </span>

                                <!-- 게시글 보기, 공유하기-->
                                <img class="message-icon" src="{{url_for('static', filename='img/message-regular.svg') }}">
                                <img class="paper-plane-icon" src="{{url_for('static', filename='img/paper-plane-regular.svg') }}">
                            </div>
                            <!-- bookmark -->
                            <div onclick = "bookmark_func('{{users.nickname}}', '{{feed.num}}')">
                                {% set nickname_list = [] %} 
                                {% for bookmark_dict in feed.bookmark %}
                                    <!-- {{ nickname_list.append(bookmark_dict['nickname']) }} -->
                                {% endfor %}
                                {% if users.nickname in nickname_list %}
                                    <img class="bookmark-icon" src="{{url_for('static', filename='img/bookmark-solid.svg') }}" data-bookmark="1">
                                {% else %}
                                    <img class="bookmark-icon" src="{{url_for('static', filename='img/bookmark-regular.svg') }}" data-bookmark="0">
                                {% endif %}
                            </div>
                        </div>

                        <!-- 피드 본문, 좋아요-->
                        <div class="feed_like_div">좋아요 {{ feed.like|length }}개</div>
                        <div class="feed_content_div">
                            <b>{{ feed.nickname }}</b>&nbsp;{{ feed.content }}
                        </div>
                    </div>
                    <!-- 댓글 더보기 -->
                    <div class='feed_reply_view_div'+ {{feed.num}} onclick= "feed_modal_func('{{feed.num}}')">
                        댓글 {{feed.reply|length}}개 더보기
                    </div>

                    <!-- 댓글 View -->
                    <div>
                        {% for reply in feed.reply[::-1][:2] %}
                            <div class='feed_reply_div'>
                                <b>{{ reply.nickname }}</b> &nbsp; {{ reply.content }}
                            </div>
                        {% endfor %}
                    </div>

                    <!-- 댓글 달기 -->
                    <div class="feed_reply_write_div">
                        <input type="text" class="feed_reply_write_{{feed.num}}" placeholder="댓글 달기.."
                            style="box-shadow:none; border: none; outline: none; width:500px;">
                        <button class="feed_reply_upload" onclick="reply_write('{{ users.nickname }}', '{{ feed.num }}')">
                            게시
                        </button>
                    </div>
                </div>
            {% endfor %}
        </div> <!-- feed_box_area -->
        
        <!-- 추천 박스 -->
        <div class="recommend_box">
            <!-- 마이 프로필 -->
            <div class = "recommend_box_myprofile_div">
                <div class='rcbox_myprofile_div'>
                    <a id="tag_a" href="{{ url_for('profile', feed_nickname = users.nickname) }}">
                        <div class='rcbox_profile_div'>
                            <div class="rcbox_profile_box_div">
                                <img class="rcbox_profile_img" src="{{ users.profile_img }}">
                            </div>
                            <div class="rcbox_nickname_name_box_div">
                                <div class="rcbox_nickname_box">{{ users.nickname }}</div>
                                <div class="rcbox_name_box">{{ users.name}}</div>
                            </div>
                        </div>
                    </a>
                </div>            
            </div>

            <!-- 회원님을 위한 추천 -->
            <div style="display: flex;flex-direction: row; justify-content: space-between; margin:15px 0 15px 0;">
                <div style="font-weight: bold; color: gray">
                    회원님을 위한 추천
                </div>
                <div>
                    <a href="#" style="font-weight: bold;color: black;text-decoration: none">모두보기</a>
                </div>
            </div>
            
            <!-- 추천 회원 출력  -->
            {% if recommend == '추천 할 회원이 없습니다.' %}
                <div>추천 할 회원이 없습니다.</div>
            {% else %}
                {% for reco in recommend %}
                    <div style="display:flex; flex-direction:row; justify-content: space-between; align-items: center; margin:10px 0px 10px 0px">
                        <div style="display: flex; flex-direction: row">
                            <div class="box" style="width: 35px; height: 35px">
                                <img class="profile"
                                    src="{{ reco.profile_img }}">
                            </div>
                            <div style="margin-left:10px; text-align:left">
                                <div id="mynick{{ reco.nickname }}"
                                    style="font-weight:bold; font-size: 14px">{{ reco.nickname }}</div>
                                <div style="color:gray; font-size:14px">인기</div>
                            </div>
                        </div>

                        <div id="follow{{ reco.nickname }}">
                            <a onclick="follow('{{ reco.nickname }}')"
                            style="font-size:14px; font-weight:bold; text-decoration:none;">팔로우</a>
                        </div>
                    </div>
                {% endfor %}
            {% endif %}


            <div style="margin-top: 50px;font-size: 12px;color: gray; text-align: left"> 소개·도움말·홍보 센터·API·채용 정보 <br>
                개인정보처리방침·약관·위치·인기 계정·해시태그·언어
            </div>
            <button type="button" onclick="logout()">로그아웃</button>
            <div style="margin-top: 20px;font-size: 12px;color: gray; text-align: left"> © 2022 INSTAGRAM FROM META</div>
        </div>
    </div>

<!-- 게시글 작성 모달 
<div class="modal-overlay">
    <div class="modal-post">
        <div class="box-modal">
            <div class="post-title">새 게시물 만들기</div>
            <img alt=img-upload class="post-img" src="static/nav-img/posting.png">
            <div class="post-info">사진과 동영상을 여기에 끌어다 놓으세요</div>
            <button class="btn-content">컴퓨터에서 선택</button>
            <div class="modal-close"><a href="#">close</a></div>
        </div>
    </div>
</div> -->

<!-- 화면 View 모달 
<div class="modal-overlay">
    <div class="modal-post">
        <div class="box-modal">
            <div class="post-title">새 게시물 만들기</div>
            <img alt=img-upload class="post-img" src="static/nav-img/posting.png">
            <div class="post-info">사진과 동영상을 여기에 끌어다 놓으세요</div>
            <button class="btn-content">컴퓨터에서 선택</button>
            <div class="modal-close"><a href="#">close</a></div>
        </div>
    </div>
</div>
-->
<!--
<footer class='footer' style='background-color:black; height:80px; display:flex; justify-content:center; align-item:center;'>
    <div class='footer-text' style='color:white; font-size:20px;'>
        Seonmin Kim Instgram Clone Coding Project
    </div>
</footer>
-->
</body>
</html>